<html>

<script type="text/javascript" src="js/lib/underscore-min.js"></script>
<script type="text/javascript" src="js/lib/jquery-171.js"></script>
<script type="text/javascript" src="js/lib/event.js"></script>
<script type="text/javascript" src="js/lib/util.js"></script>
<script type="text/javascript" src="js/lib/git.js"></script>

<script type="text/javascript">
    "use strict";
    var $git = new Github();
    $git.setAccessToken("3fd0db047bcbed22e09d5409f9d0f664e58dcfa1");

    var openPorts = [];
    chrome.extension.onConnect.addListener(function (port) {
        openPorts.push(port);
        var repository = $git.addRepository(port.name);
        var oneHour = 60 * 60 * 1000;
        if (((new Date()) - repository.lastFetchTime) > oneHour) {
            repository.fetchEvents();
        }
        port.onDisconnect.addListener(function () {
            openPorts = _(openPorts).without(port);
        });
        port.onMessage.addListener(function (request) {
            switch (request.type) {
                case "fetchEvents":
                    repository.fetchEvents();
                    break;
                case "filterEvents":
                    repository.fetchEvents();
                    var events = repository.filterEvents(request.filter);
                    port.postMessage({
                        type:"filtered-events",
                        payload:events,
                        repo:repository.name,
                        filter:request.filter});
                    break;
                case "fetchContributors":
                    port.postMessage({type:"contributors", payload:repository.contributors, repo:repository.name});
                    break;
                case "postStatusUpdate":
                    repository.postStatusUpdate(request.body);
                    break;
            }
        });
        if($git.user === null || !$git.hasAccessToken()){
            port.postMessage({type:"invalid-token"});
        }else{
            port.postMessage({type:"current-user", user: $git.user});
        }
    });
    var _old_raise = $git.raise.bind($git);
    $git.raise = function (event_name, args) {
        var payload = args[0];
        var repoName = args[1];
        _(openPorts).each(function (port) {
            if (port.name === repoName) {
                port.postMessage({type:event_name, payload:payload, repo:repoName});
            }
        });
        _old_raise(event_name, args);
    }
</script>
</html>