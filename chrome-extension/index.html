<html>

<script type="text/javascript" src="js/lib/underscore-min.js"></script>
<script type="text/javascript" src="js/lib/jquery-171.js"></script>
<script type="text/javascript" src="js/lib/event.js"></script>
<script type="text/javascript" src="js/lib/git.js"></script>

<script type="text/javascript">
    "use strict";
    var $git = new Github();
    $git.setAccessToken("3fd0db047bcbed22e09d5409f9d0f664e58dcf##");

    var openPorts = [];
    chrome.extension.onConnect.addListener(function(port){
        var repository = $git.addRepository(port.name);
        var oneHour = 60*60*1000;
        if(((new Date()) - repository.lastFetchTime) > oneHour){
            $git.fetchEvents(port.name);
        }
        port.onDisconnect.addListener(function(){
            openPorts = _(openPorts).without(port);
        });
        port.onMessage.addListener(function(request){
            switch (request.type) {
                case "fetchEvents":
                    $git.fetchEvents(port.name);
                    port.postMessage({type: "events", events: $git.repository[port.name].events});
                    break;
            }
        });
    });
</script>
</html>