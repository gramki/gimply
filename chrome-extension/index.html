<html>

<script type="text/javascript" src="js/lib/underscore-min.js"></script>
<script type="text/javascript" src="js/lib/jquery-171.js"></script>
<script type="text/javascript" src="js/lib/event.js"></script>
<script type="text/javascript" src="js/lib/util.js"></script>
<script type="text/javascript" src="js/lib/git.js"></script>

<script type="text/javascript">
    "use strict";
    var $git = new Github();
    var token = localStorage.getItem("access-token");
    $git.setAccessToken(token);

    var openPorts = [];
    chrome.extension.onConnect.addListener(function (port) {
        openPorts.push(port);
        var repository;
        port.onDisconnect.addListener(function () {
            openPorts = _(openPorts).without(port);
        });
        port.onMessage.addListener(function (request) {
            switch (request.type) {
                case "fetchEvents":
                    repository.fetchEvents();
                    break;
                case "filterEvents":
                    repository.fetchEvents();
                    var events = repository.filterEvents(request.filter);
                    port.postMessage({
                        type:"filtered-events",
                        payload:events,
                        repo:repository.name,
                        filter:request.filter});
                    break;
                case "fetchContributors":
                    port.postMessage({type:"contributors", payload:repository.getActiveContributors(), repo:repository.name});
                    sendUserRepoAssociation(repository.name);
                    break;
                case "postStatusUpdate":
                    repository.postStatusUpdate(request.body);
                    break;
                case "setAccessToken":
                    $git.setAccessToken(request.token);
                    repository = $git.addRepository(port.name);
                    repository.fetchEvents();
                    break;
            }
        });
        if($git.user === null || !$git.hasAccessToken()){
            port.postMessage({type:"invalid-token"});
        }else{
            repository = $git.addRepository(port.name);
            var oneHour = 60 * 60 * 1000;
            if (((new Date()) - repository.lastFetchTime) > oneHour) {
                repository.fetchEvents();
            }
            port.postMessage({type:"current-user", payload: $git.user});
            sendUserRepoAssociation(repository.name);
        }
    });

    function postToAllPorts(event_name, payload, repoName){
        _(openPorts).each(function (port) {
            if (port.name === repoName) {
                port.postMessage({type:event_name, payload:payload, repo:repoName});
            }
        });
    }
    var _old_raise = $git.raise.bind($git);
    $git.raise = function (event_name, args) {
        var payload = args[0];
        var repoName = args[1];
        postToAllPorts(event_name, payload, repoName);
        _old_raise(event_name, args);
    }
    function sendUserRepoAssociation(repoName){
        var repository = $git.repository[repoName];
        if(_.chain(repository.contributors).keys().include($git.user.login).value()){
            postToAllPorts("user-contributes", repoName, repoName);
        }
    }
    $git.on("contributor", function(contributor, repoName){
        if(contributor.login === $git.user.login){
            sendUserRepoAssociation(repoName);
        }
    });
</script>

<script type="text/javascript">
    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        switch (request.type) {
            case "save":
                localStorage.setItem(request.key, request.value);
                if(request.key === 'access-token'){
                    $git.setAccessToken(request.value)
                }
                sendResponse("saved");
                break;
            case "get":
                sendResponse({
                    type:"get",
                    key:request.key,
                    value:localStorage.getItem(request.key)
                });
                break;

        }
    });
</script>
</html>